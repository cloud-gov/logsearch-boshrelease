#!/usr/bin/env bash

set -e -u

# shellcheck disable=1091
source /var/vcap/packages/openjdk-11/bosh/compile.env

tar xzf logstash/logstash-7.9.3.tar.gz -C "${BOSH_INSTALL_TARGET}" --strip-components 1

export PATH="${BOSH_INSTALL_TARGET}/bin:${PATH}"

# Installs missing plugins
logstash-plugin install "file://${PWD}/logstash/logstash-filter-alter-3.0.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-input-relp-3.0.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-filter-translate-3.0.3.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-input-syslog-3.2.2.zip"
logstash-plugin install "file://${PWD}/logstash/logstash-output-syslog-3.0.5.zip"

# Removes JndiLookup Class to address the log4j log4shell vulnerability
zip -q -d "${BOSH_INSTALL_TARGET}/logstash-core/**/*/log4j-core-2.*" "org/apache/logging/log4j/core/lookup/JndiLookup.class"